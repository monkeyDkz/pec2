# üß™ Guide de Tests Complets A √† Z

## üìã Vue d'ensemble

Ce guide vous permet de tester l'int√©gralit√© de la plateforme de paiement, de l'inscription utilisateur au remboursement, en passant par la validation administrative.

## üöÄ Pr√©paration de l'Environnement

### D√©marrage des Services
```bash
cd /Users/zahidikays/Desktop/4AWD/S2/pec_2/pec/payment-platform

# D√©marrer tous les services
docker-compose up -d

# V√©rifier que tous les services sont actifs
docker-compose ps
```

### Variables Globales
```bash
#!/bin/bash
# Configuration globale pour tous les tests

BACKEND_URL="http://localhost:3000"
PSP_URL="http://localhost:3002"
FRONTEND_URL="http://localhost:8080"

# Credentials admin
ADMIN_EMAIL="admin@example.com"
ADMIN_PASSWORD="admin123456"

# Credentials marchand existant (TechShop)
EXISTING_API_KEY="tech_shop_api_key_123456789abcdef"
EXISTING_API_SECRET="tech_shop_secret_987654321fedcba"
```

## üîÑ Workflow Complet End-to-End

### Script de Test Int√©gral
```bash
#!/bin/bash
# test-complete-workflow.sh

echo "üéØ ================================================================"
echo "üéØ TEST COMPLET PLATEFORME DE PAIEMENT A √† Z"
echo "üéØ ================================================================"
echo "üéØ √âtapes : Inscription ‚Üí Marchand ‚Üí Admin ‚Üí Paiement ‚Üí Remboursement"
echo "üéØ ================================================================"

# Configuration
BACKEND_URL="http://localhost:3000"
PSP_URL="http://localhost:3002"
TIMESTAMP=$(date +%s)
TEST_EMAIL="fulltest.user.$TIMESTAMP@example.com"
TEST_PASSWORD="testPassword123"

# Fonction d'attente avec animation
wait_with_animation() {
    local seconds=$1
    local message=${2:-"Traitement en cours"}
    echo "‚è≥ $message..."
    for i in $(seq 1 $seconds); do
        echo -n "."
        sleep 1
    done
    echo " ‚úÖ Termin√©"
}

# Fonction de v√©rification de succ√®s
check_success() {
    local response="$1"
    local step="$2"
    local success=$(echo "$response" | jq -r '.success // false')
    if [ "$success" != "true" ]; then
        echo "‚ùå √âCHEC √† l'√©tape: $step"
        echo "$response" | jq '.'
        exit 1
    fi
}

echo ""
echo "üîç √âTAPE 0: V√âRIFICATION DES SERVICES"
echo "===================================="

echo "üì° Backend..."
BACKEND_HEALTH=$(curl -s $BACKEND_URL/health)
echo "‚úÖ Backend: $(echo $BACKEND_HEALTH | jq -r '.message')"

echo "üì° PSP..."
PSP_HEALTH=$(curl -s $PSP_URL/health)
echo "‚úÖ PSP: $(echo $PSP_HEALTH | jq -r '.service // .message')"

echo ""
echo "üë§ √âTAPE 1: INSCRIPTION UTILISATEUR"
echo "==================================="

echo "üìß Email de test: $TEST_EMAIL"

REGISTER_RESPONSE=$(curl -s -X POST $BACKEND_URL/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "'$TEST_EMAIL'",
    "password": "'$TEST_PASSWORD'",
    "first_name": "Test",
    "last_name": "FullWorkflow",
    "phone": "+33123456789"
  }')

check_success "$REGISTER_RESPONSE" "Inscription utilisateur"

USER_ID=$(echo $REGISTER_RESPONSE | jq -r '.data.user_id')
echo "‚úÖ Utilisateur cr√©√©: $USER_ID"

echo ""
echo "‚úâÔ∏è  √âTAPE 2: VALIDATION EMAIL"
echo "============================="

wait_with_animation 3 "R√©cup√©ration du token de validation"

# R√©cup√©ration du token depuis les logs
VALIDATION_TOKEN=$(docker logs payment_backend 2>&1 | grep "Validation token:" | tail -1 | sed 's/.*Validation token: //')
echo "üé´ Token de validation: ${VALIDATION_TOKEN:0:50}..."

VALIDATION_RESPONSE=$(curl -s -X POST $BACKEND_URL/api/auth/validate-email \
  -H "Content-Type: application/json" \
  -d '{"token": "'$VALIDATION_TOKEN'"}')

check_success "$VALIDATION_RESPONSE" "Validation email"
echo "‚úÖ Email valid√© avec succ√®s"

echo ""
echo "üîë √âTAPE 3: CONNEXION UTILISATEUR"
echo "================================="

LOGIN_RESPONSE=$(curl -s -X POST $BACKEND_URL/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "'$TEST_EMAIL'",
    "password": "'$TEST_PASSWORD'"
  }')

check_success "$LOGIN_RESPONSE" "Connexion utilisateur"

USER_TOKEN=$(echo $LOGIN_RESPONSE | jq -r '.data.token')
echo "‚úÖ Connexion r√©ussie"
echo "üîë Token utilisateur: ${USER_TOKEN:0:50}..."

echo ""
echo "üè™ √âTAPE 4: DEMANDE CR√âATION MARCHAND"
echo "===================================="

MERCHANT_REQUEST=$(curl -s -X POST $BACKEND_URL/api/merchants \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $USER_TOKEN" \
  -d '{
    "name": "FullTest Shop '$TIMESTAMP'",
    "description": "Boutique de test workflow complet",
    "website_url": "https://fulltest-'$TIMESTAMP'.example.com",
    "business_type": "e-commerce",
    "company_name": "FullTest Shop SARL",
    "company_address": "123 Rue du Test Complet, 75001 Paris",
    "company_phone": "+33123456789",
    "company_email": "contact@fulltest-'$TIMESTAMP'.example.com",
    "siret": "12345678901234",
    "webhook_url": "https://fulltest-'$TIMESTAMP'.example.com/webhook"
  }')

check_success "$MERCHANT_REQUEST" "Demande cr√©ation marchand"

MERCHANT_ID=$(echo $MERCHANT_REQUEST | jq -r '.data.merchant_id')
echo "‚úÖ Demande marchand cr√©√©e: $MERCHANT_ID"

echo ""
echo "üë®‚Äçüíº √âTAPE 5: CONNEXION ADMIN"
echo "=============================

ADMIN_LOGIN=$(curl -s -X POST $BACKEND_URL/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@example.com",
    "password": "admin123456"
  }')

check_success "$ADMIN_LOGIN" "Connexion admin"

ADMIN_TOKEN=$(echo $ADMIN_LOGIN | jq -r '.data.token')
echo "‚úÖ Admin connect√©"
echo "üîë Token admin: ${ADMIN_TOKEN:0:50}..."

echo ""
echo "‚úÖ √âTAPE 6: VALIDATION MARCHAND PAR ADMIN"
echo "========================================="

VALIDATION_ADMIN=$(curl -s -X PUT "$BACKEND_URL/api/admin/merchants/$MERCHANT_ID/validate" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -d '{
    "validation_notes": "Test workflow complet - Marchand valid√© automatiquement"
  }')

check_success "$VALIDATION_ADMIN" "Validation marchand"

API_KEY=$(echo $VALIDATION_ADMIN | jq -r '.data.api_key')
API_SECRET=$(echo $VALIDATION_ADMIN | jq -r '.data.api_secret')

echo "‚úÖ Marchand valid√© avec succ√®s"
echo "üîë Credentials g√©n√©r√©s:"
echo "   API Key: $API_KEY"
echo "   API Secret: $API_SECRET"

echo ""
echo "üí≥ √âTAPE 7: CR√âATION TRANSACTION"
echo "==============================="

ORDER_ID="FULLTEST_ORDER_$TIMESTAMP"

TRANSACTION_RESPONSE=$(curl -s -X POST $BACKEND_URL/api/transactions \
  -H "Content-Type: application/json" \
  -H "X-API-ID: $API_KEY" \
  -H "X-API-SECRET: $API_SECRET" \
  -d '{
    "order_id": "'$ORDER_ID'",
    "amount": 299.99,
    "currency": "EUR",
    "customer_email": "customer.fulltest@example.com",
    "customer_first_name": "Customer",
    "customer_last_name": "FullTest",
    "description": "Produit Test Workflow Complet",
    "success_url": "https://fulltest.example.com/success",
    "cancel_url": "https://fulltest.example.com/cancel",
    "webhook_url": "https://fulltest.example.com/webhook",
    "metadata": {
      "test_type": "full_workflow",
      "timestamp": "'$TIMESTAMP'"
    }
  }')

check_success "$TRANSACTION_RESPONSE" "Cr√©ation transaction"

TRANSACTION_ID=$(echo $TRANSACTION_RESPONSE | jq -r '.data.transaction_id')
PAYMENT_URL=$(echo $TRANSACTION_RESPONSE | jq -r '.data.payment_url')
PAYMENT_TOKEN=$(echo $PAYMENT_URL | sed 's/.*token=\([^&]*\).*/\1/')

echo "‚úÖ Transaction cr√©√©e:"
echo "   ID: $TRANSACTION_ID"
echo "   Montant: 299.99 EUR"
echo "   Token: ${PAYMENT_TOKEN:0:50}..."

echo ""
echo "üí∏ √âTAPE 8: TRAITEMENT PAIEMENT R√âUSSI"
echo "======================================"

PAYMENT_SUCCESS=$(curl -s -X POST "$BACKEND_URL/api/transactions/$TRANSACTION_ID/process" \
  -H "Content-Type: application/json" \
  -d '{
    "token": "'$PAYMENT_TOKEN'",
    "payment_method": {
      "type": "card",
      "card_number": "4111111111111111",
      "cardholder_name": "Customer FullTest",
      "expiry_month": "12",
      "expiry_year": "2027",
      "cvv": "123"
    }
  }')

check_success "$PAYMENT_SUCCESS" "Paiement"

OPERATION_ID=$(echo $PAYMENT_SUCCESS | jq -r '.data.operation_id')
PSP_REFERENCE=$(echo $PAYMENT_SUCCESS | jq -r '.data.psp_reference')

echo "‚úÖ Paiement initi√©:"
echo "   Op√©ration: $OPERATION_ID"
echo "   PSP Ref: $PSP_REFERENCE"

wait_with_animation 6 "Traitement PSP et webhook"

echo ""
echo "üìä √âTAPE 9: V√âRIFICATION STATUT TRANSACTION"
echo "==========================================="

TRANSACTION_STATUS=$(curl -s -H "X-API-ID: $API_KEY" -H "X-API-SECRET: $API_SECRET" \
  "$BACKEND_URL/api/transactions/$TRANSACTION_ID")

check_success "$TRANSACTION_STATUS" "R√©cup√©ration statut"

FINAL_STATUS=$(echo $TRANSACTION_STATUS | jq -r '.data.status')
OPERATIONS_COUNT=$(echo $TRANSACTION_STATUS | jq '.data.operations | length')

echo "‚úÖ Statut final transaction: $FINAL_STATUS"
echo "‚úÖ Nombre d'op√©rations: $OPERATIONS_COUNT"

if [ "$OPERATIONS_COUNT" -gt 0 ]; then
    echo "üìã D√©tail des op√©rations:"
    echo $TRANSACTION_STATUS | jq '.data.operations[] | "   üí≥ \(.type) - \(.status) - \(.amount) \(.currency) - PSP: \(.psp_reference // "N/A")"'
    
    # V√©rifier s'il y a une capture r√©ussie pour le remboursement
    CAPTURE_SUCCESS=$(echo $TRANSACTION_STATUS | jq '.data.operations[] | select(.type == "capture" and (.status == "completed" or .status == "success"))' | jq -s 'length')
    
    if [ "$CAPTURE_SUCCESS" -gt 0 ]; then
        echo ""
        echo "üí∞ √âTAPE 10: REMBOURSEMENT PARTIEL"
        echo "=================================="
        
        REFUND_RESPONSE=$(curl -s -X POST "$BACKEND_URL/api/transactions/$TRANSACTION_ID/refund" \
          -H "Content-Type: application/json" \
          -H "X-API-ID: $API_KEY" \
          -H "X-API-SECRET: $API_SECRET" \
          -d '{
            "amount": 100.00,
            "reason": "Test remboursement workflow complet"
          }')
        
        if [ "$(echo $REFUND_RESPONSE | jq -r '.success')" == "true" ]; then
            echo "‚úÖ Remboursement initi√©:"
            echo $REFUND_RESPONSE | jq '.data'
            
            wait_with_animation 5 "Traitement remboursement PSP"
            
            # V√©rification finale
            FINAL_CHECK=$(curl -s -H "X-API-ID: $API_KEY" -H "X-API-SECRET: $API_SECRET" \
              "$BACKEND_URL/api/transactions/$TRANSACTION_ID")
            
            FINAL_OPERATIONS=$(echo $FINAL_CHECK | jq '.data.operations | length')
            CAPTURE_COUNT=$(echo $FINAL_CHECK | jq '.data.operations[] | select(.type == "capture")' | jq -s 'length')
            REFUND_COUNT=$(echo $FINAL_CHECK | jq '.data.operations[] | select(.type == "refund")' | jq -s 'length')
            
            echo "‚úÖ √âtat final:"
            echo "   Total op√©rations: $FINAL_OPERATIONS"
            echo "   Captures: $CAPTURE_COUNT"
            echo "   Remboursements: $REFUND_COUNT"
        else
            echo "‚ö†Ô∏è  Remboursement √©chou√©:"
            echo $REFUND_RESPONSE | jq '.'
        fi
    else
        echo "‚ö†Ô∏è  Pas de capture r√©ussie - remboursement non possible"
    fi
fi

echo ""
echo "üìä √âTAPE 11: V√âRIFICATION ADMIN FINALE"
echo "======================================"

ADMIN_TRANSACTION_VIEW=$(curl -s -H "Authorization: Bearer $ADMIN_TOKEN" \
  "$BACKEND_URL/api/admin/transactions/$TRANSACTION_ID")

echo "üë®‚Äçüíº Vue admin de la transaction:"
echo $ADMIN_TRANSACTION_VIEW | jq '.data | {
  id: .id,
  status: .status,
  amount: .amount,
  merchant: .merchant.name,
  operations_count: (.operations | length)
}'

echo ""
echo "üéØ ================================================================"
echo "üéØ WORKFLOW COMPLET TERMIN√â AVEC SUCC√àS!"
echo "üéØ ================================================================"
echo "‚úÖ ‚úÖ Utilisateur cr√©√© et valid√©: $USER_ID"
echo "üè™ ‚úÖ Marchand cr√©√© et valid√©: $MERCHANT_ID"
echo "üîë ‚úÖ Credentials g√©n√©r√©s: $API_KEY"
echo "üí≥ ‚úÖ Transaction trait√©e: $TRANSACTION_ID"
echo "üí∞ ‚úÖ Workflow paiement et remboursement: OK"
echo "üë®‚Äçüíº ‚úÖ Supervision admin: OK"
echo "üéØ ================================================================"
echo "üéØ TOUTES LES √âTAPES VALID√âES - PLATEFORME OP√âRATIONNELLE"
echo "üéØ ================================================================"
```

## üö¶ Tests par Sc√©narios

### 1. Test de Succ√®s Complet
```bash
#!/bin/bash
# test-success-scenario.sh

echo "‚úÖ Sc√©nario: Workflow de Succ√®s Complet"
echo "======================================="

# Utiliser le marchand existant pour plus de rapidit√©
API_KEY="tech_shop_api_key_123456789abcdef"
API_SECRET="tech_shop_secret_987654321fedcba"

# Cr√©er transaction
ORDER_ID="SUCCESS_$(date +%s)"
# ... (code de cr√©ation transaction)

# Paiement avec carte valide
# Card: 4111111111111111

# V√©rifier succ√®s
# Faire remboursement partiel
# V√©rifier remboursement
```

### 2. Test d'√âchec de Paiement
```bash
#!/bin/bash
# test-failure-scenario.sh

echo "‚ùå Sc√©nario: √âchec de Paiement"
echo "=============================="

# Cr√©er transaction
# Utiliser carte d√©clin√©e: 4000000000000002
# V√©rifier √©chec
# V√©rifier pas d'op√©ration cr√©√©e
```

### 3. Test de Refus Marchand
```bash
#!/bin/bash
# test-merchant-rejection.sh

echo "‚ùå Sc√©nario: Refus de Marchand"
echo "============================="

# Cr√©er utilisateur
# Demander marchand
# Admin refuse la demande
# V√©rifier statut 'rejected'
```

### 4. Test de Suspension
```bash
#!/bin/bash
# test-suspension-scenario.sh

echo "‚è∏Ô∏è  Sc√©nario: Suspension de Marchand"
echo "===================================="

# Cr√©er et valider marchand
# Admin suspend le marchand
# Tenter de cr√©er transaction (doit √©chouer)
# Admin r√©active le marchand
# Cr√©er transaction (doit r√©ussir)
```

## üîç Tests de Performance

### Test de Charge Basique
```bash
#!/bin/bash
# test-performance.sh

echo "üöÄ Test de Performance Basique"
echo "=============================="

API_KEY="tech_shop_api_key_123456789abcdef"
API_SECRET="tech_shop_secret_987654321fedcba"

# Cr√©er 10 transactions simultan√©ment
for i in {1..10}; do
    (
        ORDER_ID="PERF_TEST_${i}_$(date +%s)"
        curl -s -X POST http://localhost:3000/api/transactions \
          -H "Content-Type: application/json" \
          -H "X-API-ID: $API_KEY" \
          -H "X-API-SECRET: $API_SECRET" \
          -d '{
            "order_id": "'$ORDER_ID'",
            "amount": '$((i * 10)).99',
            "currency": "EUR",
            "customer_email": "perf'$i'@example.com",
            "customer_first_name": "Perf",
            "customer_last_name": "Test'$i'",
            "description": "Test performance '$i'"
          }' | jq '.data.transaction_id' &
    )
done

wait
echo "‚úÖ 10 transactions cr√©√©es simultan√©ment"
```

## üêõ Tests de Gestion d'Erreurs

### Test d'Erreurs de Validation
```bash
#!/bin/bash
# test-validation-errors.sh

echo "‚ö†Ô∏è  Test de Gestion d'Erreurs"
echo "============================="

API_KEY="tech_shop_api_key_123456789abcdef"
API_SECRET="tech_shop_secret_987654321fedcba"

# Test 1: Montant invalide
echo "1. Test montant n√©gatif..."
NEGATIVE_AMOUNT=$(curl -s -X POST http://localhost:3000/api/transactions \
  -H "Content-Type: application/json" \
  -H "X-API-ID: $API_KEY" \
  -H "X-API-SECRET: $API_SECRET" \
  -d '{
    "order_id": "ERROR_TEST_1",
    "amount": -50.00,
    "currency": "EUR",
    "customer_email": "error@example.com",
    "description": "Test erreur montant n√©gatif"
  }')

echo "R√©sultat: $(echo $NEGATIVE_AMOUNT | jq -r '.error // "Pas d'erreur d√©tect√©e"')"

# Test 2: Email invalide
echo "2. Test email invalide..."
INVALID_EMAIL=$(curl -s -X POST http://localhost:3000/api/transactions \
  -H "Content-Type: application/json" \
  -H "X-API-ID: $API_KEY" \
  -H "X-API-SECRET: $API_SECRET" \
  -d '{
    "order_id": "ERROR_TEST_2",
    "amount": 50.00,
    "currency": "EUR",
    "customer_email": "email-invalide",
    "description": "Test erreur email"
  }')

echo "R√©sultat: $(echo $INVALID_EMAIL | jq -r '.error // "Pas d'erreur d√©tect√©e"')"

# Test 3: Credentials invalides
echo "3. Test credentials invalides..."
INVALID_CREDS=$(curl -s -X POST http://localhost:3000/api/transactions \
  -H "Content-Type: application/json" \
  -H "X-API-ID: fake_key" \
  -H "X-API-SECRET: fake_secret" \
  -d '{
    "order_id": "ERROR_TEST_3",
    "amount": 50.00,
    "currency": "EUR",
    "customer_email": "test@example.com",
    "description": "Test erreur credentials"
  }')

echo "R√©sultat: $(echo $INVALID_CREDS | jq -r '.error // "Pas d'erreur d√©tect√©e"')"
```

## üìä Suivi et Monitoring des Tests

### Script de Monitoring
```bash
#!/bin/bash
# monitor-tests.sh

echo "üìä Monitoring des Tests en Temps R√©el"
echo "====================================="

# Fonction de monitoring continu
monitor_services() {
    while true; do
        clear
        echo "üì° √âtat des Services - $(date)"
        echo "==============================="
        
        # Backend
        BACKEND_STATUS=$(curl -s http://localhost:3000/health | jq -r '.message // "‚ùå Offline"')
        echo "Backend: $BACKEND_STATUS"
        
        # PSP
        PSP_STATUS=$(curl -s http://localhost:3002/health | jq -r '.service // "‚ùå Offline"')
        echo "PSP: $PSP_STATUS"
        
        # Base de donn√©es
        DB_STATUS=$(docker exec payment_mysql mysqladmin ping -h localhost --silent && echo "‚úÖ Online" || echo "‚ùå Offline")
        echo "MySQL: $DB_STATUS"
        
        echo ""
        echo "üìà M√©triques R√©centes"
        echo "===================="
        
        # Nombre de transactions du jour
        TODAY=$(date +%Y-%m-%d)
        TRANSACTIONS_TODAY=$(curl -s -H "Authorization: Bearer $ADMIN_TOKEN" \
          "http://localhost:3000/api/admin/transactions?start_date=$TODAY" | jq '.data.transactions | length')
        echo "Transactions aujourd'hui: $TRANSACTIONS_TODAY"
        
        # Webhooks PSP
        WEBHOOKS_COUNT=$(curl -s http://localhost:3002/api/webhook/history | jq '.total // 0')
        echo "Webhooks PSP envoy√©s: $WEBHOOKS_COUNT"
        
        sleep 5
    done
}

# D√©marrer le monitoring
monitor_services
```

## üîß Utilitaires de Test

### Nettoyage des Donn√©es de Test
```bash
#!/bin/bash
# cleanup-test-data.sh

echo "üßπ Nettoyage des Donn√©es de Test"
echo "==============================="

# Supprimer les utilisateurs de test
docker exec payment_mysql mysql -u root -proot payment_platform -e "
DELETE FROM users WHERE email LIKE '%test%' OR email LIKE '%fulltest%';
"

# Supprimer les marchands de test
docker exec payment_mysql mysql -u root -proot payment_platform -e "
DELETE FROM merchants WHERE name LIKE '%Test%' OR name LIKE '%FullTest%';
"

# Supprimer les transactions de test
docker exec payment_mysql mysql -u root -proot payment_platform -e "
DELETE FROM transactions WHERE order_id LIKE '%TEST%' OR order_id LIKE '%FULLTEST%';
"

echo "‚úÖ Donn√©es de test supprim√©es"
```

### G√©n√©ration de Donn√©es de Test
```bash
#!/bin/bash
# generate-test-data.sh

echo "üè≠ G√©n√©ration de Donn√©es de Test"
echo "==============================="

API_KEY="tech_shop_api_key_123456789abcdef"
API_SECRET="tech_shop_secret_987654321fedcba"

# G√©n√©rer 20 transactions de test
for i in {1..20}; do
    AMOUNT=$((RANDOM % 500 + 10))
    ORDER_ID="GENERATED_$(date +%s)_$i"
    
    curl -s -X POST http://localhost:3000/api/transactions \
      -H "Content-Type: application/json" \
      -H "X-API-ID: $API_KEY" \
      -H "X-API-SECRET: $API_SECRET" \
      -d '{
        "order_id": "'$ORDER_ID'",
        "amount": '$AMOUNT'.99,
        "currency": "EUR",
        "customer_email": "generated'$i'@example.com",
        "customer_first_name": "Generated",
        "customer_last_name": "Customer'$i'",
        "description": "Transaction g√©n√©r√©e automatiquement #'$i'"
      }' > /dev/null
    
    echo "‚úÖ Transaction $i cr√©√©e: $ORDER_ID ($AMOUNT.99 EUR)"
done

echo "üéâ 20 transactions de test g√©n√©r√©es"
```

---

**‚û°Ô∏è √âtape suivante** : [`07-api-reference.md`](./07-api-reference.md) - R√©f√©rence compl√®te des APIs
