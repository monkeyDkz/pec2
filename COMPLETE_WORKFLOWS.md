# WORKFLOWS COMPLETS DE L'APPLICATION

## 🔄 1. WORKFLOW INSCRIPTION/CONNEXION

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   INSCRIPTION   │    │  VÉRIFICATION   │    │   CONNEXION     │
│                 │    │     EMAIL       │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Register.vue    │    │ VerifyEmail.vue │    │ Login.vue       │
│ POST /register  │    │ GET /verify     │    │ POST /login     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│ Email envoyé    │    │ Compte activé   │    │ JWT + User      │
│ Token généré    │    │ Email bienvenue │    │ Redirection     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

## 🏢 2. WORKFLOW GESTION MARCHANDS

```
┌─────────────────────────────────────────────────────────────────┐
│                    UTILISATEUR CONNECTÉ                        │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  MerchantSelection.vue                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │  Existants  │ │   Créer     │ │ Mes Demandes│              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Rejoindre   │    │ Formulaire  │    │ Statut      │
│ Marchand    │    │ Création    │    │ Demandes    │
└─────────────┘    └─────────────┘    └─────────────┘
         │                   │                   
         ▼                   ▼                   
┌─────────────────────────────────────────────────────────────────┐
│              POST /api/merchants/request                        │
│  type: "join_merchant" | "create_merchant"                     │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DEMANDE EN ATTENTE                          │
│                   (status: pending)                            │
└─────────────────────────────────────────────────────────────────┘
```

## 👨‍💼 3. WORKFLOW ADMINISTRATION

```
┌─────────────────────────────────────────────────────────────────┐
│                    ADMIN DASHBOARD                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              AdminMerchantRequests.vue                         │
│                                                                 │
│  ┌─────────────────┐                  ┌─────────────────┐      │
│  │   APPROUVER     │                  │    REJETER      │      │
│  │                 │                  │                 │      │
│  └─────────────────┘                  └─────────────────┘      │
└─────────────────────────────────────────────────────────────────┘
         │                                        │
         ▼                                        ▼
┌─────────────────┐                    ┌─────────────────┐
│ POST /approve   │                    │ POST /reject    │
│                 │                    │                 │
└─────────────────┘                    └─────────────────┘
         │                                        │
         ▼                                        ▼
┌─────────────────┐                    ┌─────────────────┐
│ Création        │                    │ Status:         │
│ Merchant +      │                    │ rejected        │
│ UserMerchant    │                    │                 │
│ + API Keys      │                    │                 │
└─────────────────┘                    └─────────────────┘
         │                                        │
         ▼                                        ▼
┌─────────────────┐                    ┌─────────────────┐
│ Email           │                    │ Email           │
│ Approbation     │                    │ Refus           │
│ + API Keys      │                    │ + Raison        │
└─────────────────┘                    └─────────────────┘
```

## 💳 4. WORKFLOW PAIEMENT COMPLET

```
┌─────────────────────────────────────────────────────────────────┐
│                    TEST MERCHANT                               │
│              CartManagement.vue                                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│            POST /api/transactions/create                       │
│  {                                                             │
│    merchant_id, amount, currency, payment_method,             │
│    customer: { email, name }, callback_url                    │
│  }                                                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  BACKEND PROCESSING                            │
│  1. Validation API Keys                                        │
│  2. Création Transaction (pending)                             │
│  3. Création Operation (capture)                               │
│  4. PaymentService.sendPaymentToPSP()                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                   PSP EMULATOR                                 │
│  1. Traitement simulé                                         │
│  2. Délai configurable                                        │
│  3. Taux de succès configurable                               │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              WEBHOOK PSP → BACKEND                             │
│  POST /api/webhooks/psp-notification                          │
│  { operation_id, status, psp_reference, data }                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 MISE À JOUR STATUTS                            │
│  Operation: processing → success/failed                        │
│  Transaction: pending → success/failed                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              WEBHOOK VERS MERCHANT                             │
│  POST merchant.callback_url                                    │
│  { transaction_id, status, reference, amount }                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📊 5. WORKFLOW DASHBOARD MERCHANT

```
┌─────────────────────────────────────────────────────────────────┐
│                 MerchantDashboard.vue                          │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  GET /api/  │  │  GET /api/  │  │  GET /api/  │             │
│  │ merchants/  │  │ merchants/  │  │ merchants/  │             │
│  │ dashboard   │  │transactions │  │  settings   │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
         │                   │                   │
         ▼                   ▼                   ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│ Statistiques│    │ Liste des   │    │ Paramètres  │
│ - Revenue   │    │ Transactions│    │ - API Keys  │
│ - Volume    │    │ - Filtres   │    │ - Webhooks  │
│ - Taux      │    │ - Pagination│    │ - Équipe    │
└─────────────┘    └─────────────┘    └─────────────┘
```

## 🔄 6. WORKFLOW WEBHOOKS

```
┌─────────────────────────────────────────────────────────────────┐
│                    ÉVÉNEMENT SYSTÈME                           │
│  (Transaction, Operation, Merchant, etc.)                      │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 WEBHOOK SERVICE                                │
│  1. Formatage payload                                         │
│  2. Signature HMAC                                            │
│  3. Queue/Retry logic                                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│               POST merchant.webhook_url                        │
│  Headers:                                                      │
│  - X-Signature: HMAC-SHA256                                   │
│  - X-Event-Type: transaction.success                          │
│  Body: { transaction_id, status, amount, ... }                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                  MERCHANT ENDPOINT                             │
│  1. Vérification signature                                    │
│  2. Traitement événement                                      │
│  3. Réponse 200 OK                                            │
└─────────────────────────────────────────────────────────────────┘
```

## 🚨 GESTION D'ERREURS ET RETRY

```
┌─────────────────────────────────────────────────────────────────┐
│                   ERREUR DÉTECTÉE                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │ PSP Timeout │  │ Webhook Fail│  │ DB Error    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    RETRY LOGIC                                 │
│  - Exponential backoff                                        │
│  - Maximum attempts                                            │
│  - Dead letter queue                                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 NOTIFICATION ADMIN                             │
│  - Email alert                                                │
│  - Slack notification                                          │
│  - Dashboard alert                                             │
└─────────────────────────────────────────────────────────────────┘
```

## 📈 MONITORING ET LOGS

```
┌─────────────────────────────────────────────────────────────────┐
│                   TOUS LES ENDPOINTS                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 MIDDLEWARE LOGGING                             │
│  - Request/Response logs                                       │
│  - Performance metrics                                         │
│  - Error tracking                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │  Console    │  │  File Logs  │  │  Database   │             │
│  │   Logs      │  │             │  │    Audit    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```

## 🔐 SÉCURITÉ ET AUTHENTIFICATION

```
┌─────────────────────────────────────────────────────────────────┐
│                    TOUTES REQUÊTES                             │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                 MIDDLEWARE AUTH                                │
│  1. Vérification JWT/API Keys                                 │
│  2. Validation permissions                                     │
│  3. Rate limiting                                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐             │
│  │   PUBLIC    │  │    USER     │  │   ADMIN     │             │
│  │   Routes    │  │   Routes    │  │   Routes    │             │
│  └─────────────┘  └─────────────┘  └─────────────┘             │
└─────────────────────────────────────────────────────────────────┘
```
