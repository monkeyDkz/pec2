# üè¶ BACKEND API COMPLET - TOUTES LES ROUTES FONCTIONNELLES

## üåê ENVIRONNEMENT DOCKER

### **Variables d'environnement (.env)**
```env
# Serveur
APP_PORT=3000
NODE_ENV=development
FRONTEND_URL=http://localhost:8080

# Base de donn√©es MySQL (Docker)
DB_HOST=mysql
DB_PORT=3306
DB_USER=root
DB_PASSWORD=payment_root_password_2024
DB_NAME=payment_platform

# JWT
JWT_SECRET=your_super_secret_jwt_key_here_change_this_in_production_2024

# Email (Resend)
RESEND_API_KEY=re_6MgbSiCi_JwR6PV91j9wGVh4mAH9RMEEu
RESEND_FROM_EMAIL=onboarding@resend.dev
RESEND_TO_EMAIL=kays.zahidi@gmail.com

# Redis (Docker)
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=

# MongoDB (Docker)
MONGODB_HOST=mongodb
MONGODB_PORT=27017
MONGODB_DB_NAME=payment_analytics
MONGODB_USER=admin
MONGODB_PASSWORD=mongo_admin_2024

# Services internes
PSP_URL=http://psp-emulator:3002
BACKEND_URL=http://backend:3000

# URLs frontend
VERIFICATION_URL=http://localhost:8080/verify-email
DASHBOARD_URL=http://localhost:8080/dashboard
```

### **D√©marrage Docker**
```bash
# D√©marrer tous les services
cd /Users/zahidikays/Desktop/4AWD/S2/pec_2/pec/payment-platform
docker-compose up -d

# V√©rifier les services
docker-compose ps

# Voir les logs
docker-compose logs backend
```

---

## üë• COMPTES DE TEST (Seeders)

### **Comptes utilisateurs disponibles:**
```javascript
// Admin
email: 'admin@payment-platform.com'
password: 'AdminPassword123!'
role: 'admin'

// Merchant 1
email: 'merchant1@example.com'
password: 'MerchantPass123!'
role: 'merchant'

// Merchant 2
email: 'merchant2@example.com'
password: 'MerchantPass123!'
role: 'merchant'

// Nouvel utilisateur
email: 'newuser@example.com'
password: 'UserPass123!'
role: 'merchant'
```

---

## üîê AUTHENTIFICATION - `/api/auth`

### **Base URL:** `http://localhost:3000/api/auth`

| M√©thode | Route | Description | Auth |
|---------|-------|-------------|------|
| `POST` | `/register` | Inscription utilisateur | Public |
| `POST` | `/login` | Connexion utilisateur | Public |
| `POST` | `/verify-email` | Validation email | Public |
| `POST` | `/resend-verification` | Renvoyer email validation | Public |
| `GET` | `/profile` | Profil utilisateur | JWT |
| `GET` | `/test` | Test routes auth | Public |

### **Exemples de requ√™tes:**

#### üîπ **Inscription**
```http
POST http://localhost:3000/api/auth/register
Content-Type: application/json

{
  "email": "test@example.com",
  "password": "TestPass123!",
  "first_name": "Test",
  "last_name": "User"
}
```

#### üîπ **V√©rification Email (apr√®s inscription)**
```http
POST http://localhost:3000/api/auth/verify-email
Content-Type: application/json

{
  "token": "{{verification_token_from_email}}"
}
```

#### üîπ **Connexion**
```http
POST http://localhost:3000/api/auth/login
Content-Type: application/json

{
  "email": "admin@payment-platform.com",
  "password": "AdminPassword123!"
}
```

#### üîπ **Profil (avec JWT)**
```http
GET http://localhost:3000/api/auth/profile
Authorization: Bearer {{jwt_token}}
```

---

## üè™ MARCHANDS - `/api/merchants`

### **Base URL:** `http://localhost:3000/api/merchants`
### **Auth:** JWT Token requis pour toutes les routes

| M√©thode | Route | Description | Permissions |
|---------|-------|-------------|-------------|
| `GET` | `/dashboard` | Dashboard marchand | Authentifi√© |
| `GET` | `/` | Mes marchands | Authentifi√© |
| `GET` | `/available` | Marchands disponibles | Authentifi√© |
| `POST` | `/request` | Demande marchand | Authentifi√© |
| `GET` | `/my-requests` | Mes demandes | Authentifi√© |
| `POST` | `/join-request` | Rejoindre marchand | Authentifi√© |
| `POST` | `/create-request` | Cr√©er marchand | Authentifi√© |
| `GET` | `/:id/details` | D√©tails marchand | Membre |
| `GET` | `/:id/members` | Membres marchand | Manager+ |
| `PUT` | `/:id` | Modifier marchand | Manager+ |
| `POST` | `/:id/regenerate-keys` | R√©g√©n√©rer cl√©s API | Admin |
| `GET` | `/:id/transactions` | Transactions marchand | Membre |
| `GET` | `/:id/credentials` | Credentials marchand | Membre |
| `POST` | `/:id/refund` | Cr√©er remboursement | Manager+ |
| `GET` | `/:id/refunds` | Liste remboursements | Membre |
| `POST` | `/:id/regenerate-secret` | Nouveau secret | Admin |
| `POST` | `/:id/test-webhook` | Test webhook | Manager+ |

### **Exemples de requ√™tes:**

#### üîπ **Mes marchands (v√©rifier si utilisateur a des marchands)**
```http
GET http://localhost:3000/api/merchants
Authorization: Bearer {{jwt_token}}
```

#### üîπ **Marchands disponibles pour rejoindre**
```http
GET http://localhost:3000/api/merchants/available?page=1&limit=20
Authorization: Bearer {{jwt_token}}
```

#### üîπ **Mes demandes en cours**
```http
GET http://localhost:3000/api/merchants/my-requests
Authorization: Bearer {{jwt_token}}
```

#### üîπ **Demande cr√©ation marchand**
```http
POST http://localhost:3000/api/merchants/create-request
Authorization: Bearer {{jwt_token}}
Content-Type: application/json

{
  "merchantName": "Ma Boutique",
  "websiteUrl": "https://ma-boutique.com",
  "companyName": "Ma Boutique SARL",
  "businessType": "e-commerce",
  "description": "Vente de produits artisanaux",
  "companyAddress": "123 Rue du Commerce, Paris",
  "companyEmail": "contact@ma-boutique.com",
  "companyPhone": "+33123456789",
  "siret": "12345678901234",
  "justification": "Je souhaite cr√©er ma boutique en ligne"
}
```

#### üîπ **Rejoindre un marchand**
```http
POST http://localhost:3000/api/merchants/join-request
Authorization: Bearer {{jwt_token}}
Content-Type: application/json

{
  "merchantId": "uuid-du-marchand",
  "requestedRole": "developer",
  "justification": "Je souhaite rejoindre votre √©quipe"
}
```

#### üîπ **Dashboard marchand (si membre)**
```http
GET http://localhost:3000/api/merchants/dashboard
Authorization: Bearer {{jwt_token}}
```

---

## üëë ADMINISTRATION - `/api/admin`

### **Base URL:** `http://localhost:3000/api/admin`
### **Auth:** JWT Token + Role Admin requis

| M√©thode | Route | Description |
|---------|-------|-------------|
| `GET` | `/merchant-requests` | Liste demandes marchands |
| `GET` | `/merchant-requests/:id` | D√©tail demande |
| `POST` | `/merchant-requests/:id/approve` | Approuver demande |
| `POST` | `/merchant-requests/:id/reject` | Rejeter demande |
| `GET` | `/merchants` | Liste marchands |
| `POST` | `/merchants/:id/suspend` | Suspendre marchand |
| `POST` | `/merchants/:id/activate` | Activer marchand |
| `POST` | `/merchants/:id/regenerate-keys` | R√©g√©n√©rer cl√©s |
| `GET` | `/transactions` | Toutes transactions |
| `GET` | `/transactions/stats` | Stats transactions |
| `POST` | `/transactions/:id/refund` | Rembourser |
| `POST` | `/transactions/:id/force-complete` | Forcer validation |
| `GET` | `/stats` | Stats plateforme |
| `GET` | `/dashboard` | Dashboard admin |
| `POST` | `/impersonate/:userId` | Impersonnation |
| `GET` | `/settings` | Param√®tres plateforme |
| `POST` | `/settings` | Sauver param√®tres |

### **Exemples de requ√™tes:**

#### üîπ **Liste demandes marchands**
```http
GET http://localhost:3000/api/admin/merchant-requests?status=pending
Authorization: Bearer {{admin_jwt_token}}
```

#### üîπ **Approuver demande**
```http
POST http://localhost:3000/api/admin/merchant-requests/{{request_id}}/approve
Authorization: Bearer {{admin_jwt_token}}
Content-Type: application/json

{
  "adminNotes": "Demande approuv√©e apr√®s v√©rification"
}
```

#### üîπ **Rejeter demande**
```http
POST http://localhost:3000/api/admin/merchant-requests/{{request_id}}/reject
Authorization: Bearer {{admin_jwt_token}}
Content-Type: application/json

{
  "adminNotes": "Documents insuffisants"
}
```

#### üîπ **Dashboard admin**
```http
GET http://localhost:3000/api/admin/dashboard
Authorization: Bearer {{admin_jwt_token}}
```

---

## üí≥ TRANSACTIONS - `/api/transactions`

### **Base URL:** `http://localhost:3000/api/transactions`

| M√©thode | Route | Description | Auth |
|---------|-------|-------------|------|
| `POST` | `/` | Cr√©er transaction | API Key |
| `GET` | `/:id` | D√©tail transaction | API Key |
| `GET` | `/` | Liste transactions | API Key |
| `POST` | `/:id/process` | Traiter paiement | Token |
| `POST` | `/:id/cancel` | Annuler transaction | Token |
| `POST` | `/:transaction_id/refund` | Remboursement | API Key |
| `GET` | `/:transaction_id/operations` | Liste op√©rations | API Key |
| `GET` | `/backoffice/list` | Liste (backoffice) | JWT |
| `GET` | `/backoffice/:id` | D√©tail (backoffice) | JWT |

---

## üîÑ WEBHOOKS - `/api/webhooks`

### **Base URL:** `http://localhost:3000/api/webhooks`

| M√©thode | Route | Description | Auth |
|---------|-------|-------------|------|
| `POST` | `/psp` | Notification PSP | Signature |
| `POST` | `/psp-notification` | Notification PSP (alt) | Signature |
| `GET` | `/` | Liste webhooks | API Key |
| `POST` | `/:id/retry` | R√©essayer webhook | API Key |
| `GET` | `/stats/summary` | Stats webhooks | API Key |
| `GET` | `/backoffice/list` | Liste (backoffice) | JWT |
| `POST` | `/backoffice/retry-failed` | R√©essayer √©checs | Admin |

---

## üîó WORKFLOW COMPLET UTILISATEUR

### **üìù √âTAPE 1 : INSCRIPTION ‚Üí V√âRIFICATION ‚Üí CONNEXION**
```bash
# 1. Inscription
POST /api/auth/register
{
  "email": "nouveauuser@example.com",
  "password": "MonPass123!",
  "first_name": "Nouveau",
  "last_name": "Utilisateur"
}
# ‚Üí Utilisateur re√ßoit email de v√©rification

# 2. V√©rification email (OBLIGATOIRE)
POST /api/auth/verify-email
{
  "token": "token_from_email"
}
# ‚Üí Compte valid√© + JWT token retourn√©

# 3. Connexion (ou utiliser JWT de la v√©rification)
POST /api/auth/login
{
  "email": "nouveauuser@example.com",
  "password": "MonPass123!"
}
# ‚Üí JWT token pour futures requ√™tes
```

### **üè† √âTAPE 2 : DASHBOARD UTILISATEUR (PREMIER CHOIX)**

#### **V√©rifier l'√©tat de l'utilisateur :**
```bash
# V√©rifier si l'utilisateur a d√©j√† des marchands
GET /api/merchants
Authorization: Bearer {{jwt_token}}

# Si r√©ponse vide ‚Üí Afficher choix initial
# Si marchands pr√©sents ‚Üí Rediriger vers dashboard marchand
```

#### **Si AUCUN marchand ‚Üí Afficher 2 options :**

**Option A : Voir les marchands disponibles pour rejoindre**
```bash
GET /api/merchants/available
Authorization: Bearer {{jwt_token}}
# ‚Üí Liste des marchands existants √† rejoindre
```

**Option B : Cr√©er un nouveau marchand**
```bash
# Afficher formulaire de cr√©ation
# (Voir √âTAPE 3 ou 4)
```

**V√©rifier les demandes en cours :**
```bash
GET /api/merchants/my-requests
Authorization: Bearer {{jwt_token}}
# ‚Üí Voir si l'utilisateur a des demandes pending
```

### **ü§ù √âTAPE 3 : REJOINDRE UN MARCHAND EXISTANT**
```bash
# 1. Lister les marchands disponibles
GET /api/merchants/available?page=1&limit=20
Authorization: Bearer {{jwt_token}}

# 2. Faire la demande pour rejoindre
POST /api/merchants/join-request
Authorization: Bearer {{jwt_token}}
{
  "merchantId": "uuid-du-marchand-choisi",
  "requestedRole": "developer", // ou "manager", "support"
  "justification": "Je souhaite rejoindre votre √©quipe car..."
}

# 3. Attendre validation admin (voir √âTAPE 5)
```

### **üÜï √âTAPE 4 : CR√âER UN NOUVEAU MARCHAND**
```bash
# Faire la demande de cr√©ation
POST /api/merchants/create-request
Authorization: Bearer {{jwt_token}}
{
  "merchantName": "Ma Nouvelle Boutique",
  "websiteUrl": "https://ma-boutique.com",
  "businessType": "e-commerce", // ou "restaurant", "service", "other"
  "companyName": "Ma Boutique SARL",
  "companyAddress": "123 Rue du Commerce, 75001 Paris",
  "companyEmail": "contact@ma-boutique.com",
  "companyPhone": "+33123456789",
  "siret": "12345678901234",
  "description": "Description de mon activit√©",
  "justification": "Pourquoi je veux cr√©er ce marchand"
}

# Attendre validation admin (voir √âTAPE 5)
```

### **üëë √âTAPE 5 : VALIDATION ADMIN**
```bash
# Admin voit toutes les demandes
GET /api/admin/merchant-requests?status=pending
Authorization: Bearer {{admin_jwt_token}}

# Admin approuve une demande
POST /api/admin/merchant-requests/{{request_id}}/approve
Authorization: Bearer {{admin_jwt_token}}
{
  "adminNotes": "Demande approuv√©e apr√®s v√©rification"
}

# OU Admin rejette une demande
POST /api/admin/merchant-requests/{{request_id}}/reject
Authorization: Bearer {{admin_jwt_token}}
{
  "adminNotes": "Documents insuffisants"
}
```

### **üè™ √âTAPE 6 : DASHBOARD MARCHAND (MEMBRE VALID√â)**
```bash
# Une fois approuv√©, l'utilisateur peut acc√©der au dashboard marchand
GET /api/merchants/dashboard
Authorization: Bearer {{jwt_token}}

# Voir ses marchands
GET /api/merchants
Authorization: Bearer {{jwt_token}}

# Voir d√©tails d'un marchand sp√©cifique
GET /api/merchants/{{merchant_id}}/details
Authorization: Bearer {{jwt_token}}

# R√©cup√©rer les cl√©s API
GET /api/merchants/{{merchant_id}}/credentials
Authorization: Bearer {{jwt_token}}
```

---

## üéØ LOGIQUE FRONTEND √Ä IMPL√âMENTER

### **Apr√®s connexion/v√©rification :**
1. **V√©rifier** `GET /api/merchants` 
   - Si **vide** ‚Üí Afficher page choix (rejoindre OU cr√©er)
   - Si **non vide** ‚Üí Rediriger vers dashboard marchand

2. **Page de choix :**
   - Bouton "Rejoindre un marchand existant"
   - Bouton "Cr√©er un nouveau marchand"
   - Afficher les demandes en cours si existantes

3. **Gestion des demandes :**
   - V√©rifier r√©guli√®rement le statut des demandes
   - Notifier quand une demande est approuv√©e/rejet√©e

4. **Navigation conditionnelle :**
   - Utilisateur sans marchand ‚Üí Page choix
   - Utilisateur avec marchand(s) ‚Üí Dashboard marchand  
   - Admin ‚Üí Dashboard admin

---

## üîß TESTS ET VALIDATION

### **Route de sant√©**
```http
GET http://localhost:3000/health
```

### **Test auth**
```http
GET http://localhost:3000/api/auth/test
```

### **Test merchant (avec JWT)**
```http
GET http://localhost:3000/api/merchants/test
Authorization: Bearer {{jwt_token}}
```

### **Test admin (avec JWT Admin)**
```http
GET http://localhost:3000/api/admin/test
Authorization: Bearer {{admin_jwt_token}}
```

---

## üì± FLUX UTILISATEUR COMPLET

```
üìß INSCRIPTION ‚Üí üì¨ EMAIL ‚Üí ‚úÖ V√âRIFICATION ‚Üí üîë CONNEXION
                                                    ‚Üì
                                         üè† DASHBOARD UTILISATEUR
                                                    ‚Üì
                                            [V√©rifier marchands]
                                                    ‚Üì
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                         ‚Üì (Si AUCUN marchand)    ‚Üì (Si marchands existants)
                ü§ù CHOIX : REJOINDRE OU CR√âER    üè™ DASHBOARD MARCHAND
                         ‚Üì                         ‚Üì
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       üí≥ GESTION PAIEMENTS
        ‚Üì                                 ‚Üì       üìä TRANSACTIONS
ü§ù REJOINDRE MARCHAND            üÜï CR√âER MARCHAND  üîë CL√âS API
        ‚Üì                                 ‚Üì
üìù FORMULAIRE DEMANDE            üìã FORMULAIRE CR√âATION
        ‚Üì                                 ‚Üì
‚è≥ ATTENTE VALIDATION            ‚è≥ ATTENTE VALIDATION
        ‚Üì                                 ‚Üì
üëë ADMIN VALIDE/REJETTE          üëë ADMIN VALIDE/REJETTE
        ‚Üì                                 ‚Üì
‚úÖ ACC√àS MARCHAND                ‚úÖ NOUVEAU MARCHAND CR√â√â
        ‚Üì                                 ‚Üì
üè™ DASHBOARD MARCHAND            üè™ DASHBOARD MARCHAND
```

---

**‚úÖ BACKEND COMPLET - TOUTES LES ROUTES DOCUMENT√âES**  
**üöÄ WORKFLOW UTILISATEUR ENTI√àREMENT D√âFINI**  
**üì± PR√äT POUR D√âVELOPPEMENT FRONTEND STEP BY STEP**
